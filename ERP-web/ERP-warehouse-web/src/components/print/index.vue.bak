<template>
  <div class="print" v-loading="loading">
    <!-- 打印控件加载区  start-->
    <object id="LODOP_OB" classid="clsid:2105C259-1E0C-4534-8141-A753534CB4CA" width="0" height="0">
      <embed id="LODOP_EM" type="application/x-print-lodop" width="0" height="0" pluginspage="install_lodop32.exe">
    </object>
    <object
      style="display:none"
      id="LODOP1"
      classid="clsid:2105C259-1E0C-4534-8141-A753534CB4CA"
      width="800"
      height="400"
    >
      <param name="Caption" value="显示区">
      <param name="Border" value="0">
      <param name="Color" value="white">
      <embed
        id="LODOP_EM1"
        type="application/x-print-lodop"
        width="800"
        height="400"
        border="0"
        color="white"
        PLUGINSPAGE="install_lodop.exe"
      >
    </object>
    <!-- 打印控件加载区  end-->
    <div class="printBtnBox">
      <el-button type="primary" @click="prn_Preview('sku')">直接打印条形码</el-button>
      <el-button type="primary" @click="prn_Preview('a4')">打印A4</el-button>
      <el-button type="primary" @click="prn_Preview('prev')">预览</el-button>
    </div>
    <div v-if="$route.query.title==='打印采购清单产品条码'">
      <yt-table :selection="false" :data="data" :columns="productInfoTbCol" :border="true">
        <template slot="left">
          <el-table-column type="index" :index="indexMethod" align="center"></el-table-column>
        </template>
      </yt-table>
    </div>
  </div>
</template>

<script>
import getLodop from './LodopFuncs.js'
export default {
  data() {
    return {
      data: [],
      loading: false,
      productInfoTbCol: [
        {
          value: 'productImg',
          label: '产品图片',
          img: true,
          style: {
            width: 49,
            height: 49
          },
          bulkyHeight: 180
        },
        {
          value: 'productSku',
          label: '系统SKU'
        },
        {
          value: 'customSku',
          label: '自定义SKU'
        },
        {
          value: 'productName',
          label: '产品中文名'
        },
        {
          multi: ['requirement', 'freightAmount'],
          label: '需求数量/实际采购数量'
        },
        {
          label: '打印数量',
          render(h, scope) {
            return <el-input />
          }
        }
      ]
    }
  },
  created() {
    this.getData()
  },
  methods: {
    getData() {
      let api, params
      let { title, purchaseIds } = this.$route.query
      purchaseIds = purchaseIds.split(',')
      switch (title) {
        case '打印采购清单产品条码':
          api = 'procurement/printPurchase'
          params = { purchaseIds }
          break

        default:
          break
      }
      this.loading = true
      this.$api[api](params)
        .then(data => {
          this.loading = false
          this.data = data.rows.map(el => ({
            ...el,
            ...el.products[0]
          }))
        })
        .catch(err => {})
    },
    prn_Preview(type, num = 10) {
      this.CreatePrintPage(num)
      if (type === 'print') {
        LODOP.PRINT()
      } else {
        LODOP.PREVIEW()
      }
    },

    /**
     *插入文字
     *
     * @param {String} text 要插入的文字
     * @param {Object} style 文字样式
     */
    insertText(top, left, text, fontSize = 13, fontName = '黑体') {
      LODOP.ADD_PRINT_TEXT(top, left, '100%', '100%', text)
      LODOP.SET_PRINT_STYLEA(0, 'FontSize', fontSize)
      LODOP.SET_PRINT_STYLEA(0, 'FontName', fontName)
    },

    /**
     *生成普通条形码
     *
     * @param {String} sku 要生成条形码的字段
     */
    createBarCode(sku, customSku) {
      LODOP.ADD_PRINT_BARCODE(10, 20, 169, 60, '128Auto', sku)
      this.insertText(72, 20, customSku)
      this.insertText(92, 50, 'Made In China', 10)
    },

    CreatePrintPage(num) {
      LODOP = getLodop(
        document.getElementById('LODOP1'),
        document.getElementById('LODOP_EM1')
      )
      LODOP.PRINT_INITA(0, 0, 50, 30, '打印条码')
      LODOP.SET_PRINT_STYLE('FontName', '黑体')
      // 打印条码
      this.createBarCode('X001T8J2BV', 'M1C4-DARK-L')

      LODOP.NEWPAGEA() //分页
      // 打印条码
      this.createBarCode('123123', 'TEST')
      // 设置打印份数
      LODOP.SET_PRINT_COPIES(num)
    },

    indexMethod(index) {
      return index + 1
    }
  },
  mounted() {
    document.title = this.$route.query.title

    console.log(this.$route)
  }
}
</script>

<style lang="scss">
.print {
  width: 70%;
  margin: 0 auto;
  .printBtnBox {
    padding: 20px 0;
  }
}
</style>
<style lang="scss">
body {
  background: #fff;
}
</style>
